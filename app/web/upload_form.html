<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Health Files</title>
<style>
#dropzone {
  border: 2px dashed #aaa;
  padding: 30px;
  text-align: center;
  margin-bottom: 20px;
  border-radius: 6px;
  background: #f9f9f9;
}

#actions {
  margin-bottom: 20px;
}

#uploadButton, #chooseButton {
  padding: 8px 16px;
  margin-right: 10px;
  border: 1px solid #888;
  border-radius: 4px;
  background: #efefef;
  cursor: pointer;
}

#uploadButton:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
</head>
<body>
<h2>Upload Files</h2>
<p id="tips">If Operator is blocked by reCAPTCHA or Cloudflare, save the page as
HTML or print to PDF and upload the file here.</p>
<div id="dropzone">Drag & drop files here or <button id="chooseButton" type="button">Choose files</button><input id="fileInput" type="file" multiple style="display:none"></div>
<div id="actions"><button id="uploadButton" type="button" disabled>Upload</button></div>
<ul id="status"></ul>
<script>
const statusEl = document.getElementById('status');
const drop = document.getElementById('dropzone');
const input = document.getElementById('fileInput');
const chooseBtn = document.getElementById('chooseButton');
const uploadBtn = document.getElementById('uploadButton');
let pendingFiles = [];

function getParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function getToken() {
  return getParam('token');
}

function uploadFile(file) {
  const line = file._line || document.createElement('li');
  line.textContent = `Uploading ${file.name}...`;
  if (!file._line) {
    statusEl.appendChild(line);
    file._line = line;
  }
  const session = getParam('session');
  const portal = getParam('portal') || '';
  const token = getToken();
  if (!session) {
    line.textContent = 'Missing session id';
    return;
  }
  const sasEndpoint = token ? '/upload/sas' : '/upload/proxy_sas';
  const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
  fetch(`${sasEndpoint}?session_key=${encodeURIComponent(session)}&filename=${encodeURIComponent(file.name)}`, { headers })
    .then(res => res.json())
    .then(data => fetch(data.url, { method: 'PUT', body: file, headers: { 'x-ms-blob-type': 'BlockBlob' } }))
    .then(resp => {
      if (resp.ok) {
        line.textContent = `Uploaded ${file.name} \u2714`;
        if (token) {
          fetch('/upload/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ session_key: session, portal: portal, filename: file.name })
          });
        }
      } else {
        line.textContent = `Upload failed ${file.name}: ${resp.status}`;
      }
    })
    .catch(err => {
      line.textContent = 'Error: ' + err;
    });
}

function addFiles(files) {
  files.forEach(file => {
    pendingFiles.push(file);
    const line = document.createElement('li');
    line.textContent = `${file.name} ready`;
    file._line = line;
    statusEl.appendChild(line);
  });
  uploadBtn.disabled = pendingFiles.length === 0;
}

drop.addEventListener('dragover', e => { e.preventDefault(); });
drop.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer && e.dataTransfer.files) {
    addFiles(Array.from(e.dataTransfer.files));
  }
});
input.addEventListener('change', e => {
  addFiles(Array.from(e.target.files));
});

chooseBtn.addEventListener('click', () => input.click());

uploadBtn.addEventListener('click', () => {
  pendingFiles.forEach(uploadFile);
  pendingFiles = [];
  uploadBtn.disabled = true;
});
</script>
</body>
</html>
