{
  "openapi": "3.1.0",
  "info": {
    "title": "Concussion Recovery App ‚Äì GPT Tools",
    "version": "1.0.0",
    "description": "Tools for triage, symptom tracking, stage guidance, and export in a concussion recovery GPT."
  },
  "servers": [
    {
      "url": "https://fortunate-contentment-production.up.railway.app",
      "description": "Production server"
    }
  ],
  "security": [
    { "bearerAuth": [] }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {}  
  },
  "paths": { 
    "/get_triage_flow": {
      "get": {
        "operationId": "getTriageFlow",
        "summary": "Get all triage questions",
        "tags": ["Triage"],
        "x-gpt-action": {
          "name": "Fetch Full Triage Flow",
          "instructions": "Use this at the start of triage to load the full question map. Walk the user through questions one at a time using `prompt`, track the `id`, and apply the `mode` (e.g., probe, clarify).\n\nKey behavior:\n- Track each answer in an `answers` map like `{ id: answer }`\n- After final question, call `/log_incident_detail` with all answers\n- If a `skip_if` is present (e.g., `seen_provider=false`), GPT should:\n  1. Skip asking the question\n  2. Infer the answer (e.g., `diagnosed_concussion=false`)\n  3. Confirm with the user: ‚ÄúI‚Äôll mark ‚Äòdiagnosed_concussion‚Äô as false ‚Äî is that okay?‚Äù\n\nüîç If the intent is `symptoms`:\n- Use `symptom_links` to match input to known symptoms\n- Ask for severity (1‚Äì10)\n- Format as: `{ symptom_id: score }`",
          "summary_keywords": ["triage", "map", "flow"]
        },
        "responses": {
          "200": {
            "description": "Returns all questions in triage map",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "flow": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "string", "example": "q1" },
                          "prompt": { "type": "string", "example": "Who are you reporting this for?" },
                          "type": { "type": "string", "example": "text" },
                          "intent": { "type": "string", "example": "reporter_role" },
                          "mode": { "type": "string", "example": "clarify", "description": "Use 'probe' to follow up, 'clarify' to confirm answer if responses lack detail or are unclear" },
                          "example_user_answers": {
                            "type": "array",
                            "items": { "type": "string" },
                            "example": ["my son", "a player", "I'm their coach"]
                          },
                          "symptom_links": {
                            "type": "array",
                            "items": { "type": "string" },
                            "example": ["headache", "dizziness"]
                          },
                          "skip_if": {
                            "type": "object",
                            "description": "If the condition is met, GPT should skip this question and infer the answer.",
                            "example": {
                              "seen_provider": false
                            }
                          }
                        },
                        "required": ["id", "prompt"]
                      }
                    }
                  },
                  "required": ["flow"]
                }
              }
            }
          }
        }
      }
    },
    "/log_incident_detail": {
      "post": {
        "operationId": "logIncidentDetail",
        "summary": "Log structured triage outcome",
        "tags": ["Triage"],
        "x-gpt-action": {
          "name": "Log Incident Details",
          "instructions": "Call this after completing triage. Format payload as:\n- `user_id`: string\n- `timestamp`: ISO date string\n- `answers`: a dictionary mapping question IDs to answers\n\nIf including `symptoms`, pass them as a **dictionary**: `{ \"headache\": 7, \"dizziness\": 2 }`.\nAvoid sending it as a list.\nScores should range from 1 (mild) to 10 (severe). If score is unclear, use 1 as default.",
          "summary_keywords": ["log", "incident", "triage"]
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "user_id": {
                    "type": "string",
                    "example": "user_abc123"
                  },
                  "timestamp": {
                    "type": "string",
                    "format": "date-time",
                    "example": "2025-05-13T00:00:00Z"
                  },
                  "answers": {
                    "type": "object",
                    "description": "Key-value map of triage answers. Use string, boolean, or list of strings. For `symptoms`, provide a dictionary of { symptom_id: score }.",
                    "properties": {
                      "reporter_role": { "type": "string", "example": "my son" },
                      "sport_type": { "type": "string", "example": "hockey" },
                      "age_group": { "type": "string", "example": "U9" },
                      "team_id": { "type": "string", "example": "Ted Reeves Tornados" },
                      "injury_date": { "type": "string", "format": "date", "example": "2025-05-05" },
                      "injury_context": { "type": "string", "example": "He hit his head on the boards" },
                      "symptoms": {
                        "type": "object",
                        "description": "Dictionary of symptom IDs and their scores (1‚Äì10)",
                        "example": { "headache": 7, "dizziness": 2 }
                      },
                      "lost_consciousness": { "type": "boolean", "example": false },
                      "seen_provider": { "type": "boolean", "example": true },
                      "diagnosed_concussion": { "type": "boolean", "example": false },
                      "still_symptomatic": { "type": "boolean", "example": true },
                      "cleared_to_play": { "type": "boolean", "example": false }
                    },
                    "example": {
                      "reporter_role": "my son",
                      "sport_type": "hockey",
                      "age_group": "U9",
                      "team_id": "Ted Reeves Tornados",
                      "injury_date": "2025-05-05",
                      "injury_context": "He got hit from behind and hit his head on the boards",
                      "symptoms": { "headache": 7, "dizziness": 2 },
                      "lost_consciousness": false,
                      "seen_provider": true,
                      "diagnosed_concussion": false,
                      "still_symptomatic": true,
                      "cleared_to_play": false
                    }
                  }
                },
                "required": ["user_id", "timestamp", "answers"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Incident log saved"
          }
        }
      }
    },
    "/assess_concussion": {
      "post": {
        "operationId": "assessConcussion",
        "summary": "Evaluate red flags and symptom severity",
        "tags": ["Assessment"],
        "x-gpt-action": {
          "name": "Assess Concussion Risk",
          "instructions": "Use this after symptoms have been logged to check for red flags or high-risk patterns. Submit only the `user_id`.\n\nIf:\n- `concussion_likely = true`, emphasize monitoring and urge clinical evaluation.\n- `red_flags` are present, gently but clearly recommend urgent medical attention.\n- Only `moderate_risk_symptoms` exist, advise rest and monitoring, and suggest seeing a provider if symptoms persist or worsen.\n\nExample phrases:\n- ‚ÄúSome symptoms raise concern. It‚Äôs best to check with a healthcare provider.‚Äù\n- ‚ÄúThis pattern suggests a possible concussion. Please rest and monitor closely.‚Äù\n- ‚ÄúRed flags were detected ‚Äî please seek clinical help immediately.‚Äù",
          "summary_keywords": ["concussion", "assessment", "red flags"]
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "user_id": {
                    "type": "string",
                    "description": "User ID to assess symptom log for",
                    "example": "user_abc123"
                  }
                },
                "required": ["user_id"]
              },
              "examples": {
                "basic": {
                  "summary": "Assess recent symptoms for user",
                  "value": {
                    "user_id": "user_child_hockey"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Returns red flag and risk-level symptom findings, plus an assessment summary and recommendation text.",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "concussion_likely": {
                      "type": "boolean",
                      "description": "True if red flags, high risk symptoms, or 3+ moderate symptoms were found"
                    },
                    "red_flags": {
                      "type": "array",
                      "items": { "type": "string" },
                      "description": "Red flag symptoms ‚Äî these require urgent attention"
                    },
                    "high_risk_symptoms": {
                      "type": "array",
                      "items": { "type": "string" },
                      "description": "High-risk symptoms ‚Äî clinical check is advised"
                    },
                    "moderate_risk_symptoms": {
                      "type": "array",
                      "items": { "type": "string" },
                      "description": "Moderate symptoms ‚Äî monitor and seek help if they persist"
                    },
                    "summary": {
                      "type": "string",
                      "description": "Human-readable assessment summary for the user"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/log_symptoms": {
      "post": {
        "operationId": "logSymptoms",
        "summary": "Log symptom check-in",
        "tags": ["Symptoms"],
        "x-gpt-action": {
          "name": "Log Symptoms",
          "instructions": "Use this to log new or updated symptoms after triage. Ask the user to rate each symptom from 1 (very mild) to 10 (very severe). Match to a known symptom definition when possible using `symptom_input`. If there‚Äôs no match, store it with category `other`. Include optional notes if the user adds context (e.g., time of day, triggers).",
          "summary_keywords": ["symptom", "log", "check-in"]
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["user_id", "timestamp", "symptoms"],
                "properties": {
                  "user_id": {
                    "type": "string",
                    "description": "Unique user ID",
                    "example": "user_abc123"
                  },
                  "timestamp": {
                    "type": "string",
                    "format": "date-time",
                    "description": "When the check-in occurred",
                    "example": "2025-05-13T16:30:00Z"
                  },
                  "symptoms": {
                    "type": "array",
                    "description": "List of symptoms reported by the user",
                    "items": {
                      "type": "object",
                      "required": ["symptom_input", "score"],
                      "properties": {
                        "symptom_input": {
                          "type": "string",
                          "description": "User's phrase describing the symptom",
                          "example": "headache"
                        },
                        "score": {
                          "type": "integer",
                          "description": "Severity score from 1 (mild) to 10 (severe). GPT should ask the user how much this symptom is affecting them on that scale.",
                          "example": 5
                        },
                        "notes": {
                          "type": "string",
                          "description": "Optional user-provided notes",
                          "example": "mostly in the morning or after reading"
                        }
                      }
                    }
                  }
                }
              },
              "examples": {
                "checkin": {
                  "summary": "Typical symptom check-in",
                  "value": {
                    "user_id": "abc123",
                    "timestamp": "2025-05-13T16:30:00Z",
                    "symptoms": [
                      { "symptom_input": "headache", "score": 4 },
                      { "symptom_input": "dizziness", "score": 3, "notes": "especially after standing up" }
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Symptoms logged successfully"
          }
        }
      }
    },
    "/get_stage_guidance": {
      "post": {
        "operationId": "getStageGuidance",
        "summary": "Infer recovery stage",
        "tags": ["Assessment"],
        "x-gpt-action": {
          "name": "Get Stage Guidance",
          "instructions": "Use this after a symptom check-in to determine the user's current recovery stage.\n\nRequired:\n- `user_id`: unique ID used in prior logs\n\nOptional:\n- `symptoms`: dictionary of { symptom_id: score }, if triage not done\n- `injury_date`: ISO date string if not previously logged\n- `checkin_time`: timestamp for when this check-in occurred (default is now)\n\nIf `symptoms` and `injury_date` are not included, the system will fetch recent symptom logs. If missing, notify the user to complete a triage check-in.\n\nüß† How to communicate results:\n- Provide a brief, clear explanation of the user's current recovery stage (e.g., 'You‚Äôre currently in Stage 2 ‚Äì Light Activity').\n- Be empathetic and reassuring: 'Everyone heals at a different pace. Let‚Äôs make sure we‚Äôre tracking things properly.'\n- Offer return-to-play guidance: explain what is and isn‚Äôt safe right now, based on the stage.\n- Be prepared to answer user questions, like whether they can return to practice or competition.\n- Always remind them: 'I'm not a doctor, but I can help guide you through the structured recovery steps.'",
          "summary_keywords": ["stage", "guidance", "recovery"]
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["user_id"],
                "properties": {
                  "user_id": {
                    "type": "string",
                    "description": "User ID used in previous logs",
                    "example": "user_abc123"
                  },
                  "injury_date": {
                    "type": "string",
                    "format": "date",
                    "description": "Injury date if triage not done",
                    "example": "2025-05-01"
                  },
                  "symptoms": {
                    "type": "object",
                    "description": "Dictionary of symptoms and severity if check-in not done",
                    "example": {
                      "headache": 5,
                      "dizziness": 3
                    }
                  },
                  "checkin_time": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Timestamp of check-in, defaults to now",
                    "example": "2025-05-15T10:00:00Z"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Returns inferred stage and recovery details",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "stage_id": { "type": "string", "example": "stage_2" },
                    "stage_name": { "type": "string", "example": "Light Aerobic Exercise" },
                    "stage_summary": {
                      "type": "string",
                      "example": "You may begin light movement like walking or stationary biking."
                    },
                    "allowed_activities": {
                      "type": "array",
                      "items": { "type": "string" },
                      "example": ["Walking", "Stationary cycling", "Gentle stretching"]
                    },
                    "progression_criteria": {
                      "type": "array",
                      "items": { "type": "string" },
                      "example": [
                        "At least 24 hours symptom-free at this level.",
                        "No symptom worsening with light exertion."
                      ]
                    },
                    "matched_factors": {
                      "type": "object",
                      "properties": {
                        "consecutive_mild_days": { "type": "integer", "example": 2 },
                        "most_recent_mild_day": { "type": "string", "format": "date", "example": "2025-05-13" },
                        "max_score_today": { "type": "integer", "example": 2 }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/export_summary": {
      "post": {
        "operationId": "exportSummary",
        "summary": "Export summary as PDF and FHIR bundle",
        "tags": ["Export"],
        "x-gpt-action": {
          "name": "Export Summary",
          "instructions": "Call this to generate a follow-up care summary for a user. You must pass the `user_id` used in prior triage or symptom logs.\n\nThis action will return:\n- `pdf_url`: A downloadable PDF file with triage, symptom, and stage information\n- `fhir_bundle`: A structured medical handoff in FHIR format\n\nüß† How to communicate results:\n- Tell the user: 'Here‚Äôs a summary of what we‚Äôve logged together.'\n- If they‚Äôre a parent or coach, say: 'You can share this PDF with your doctor, school, or coach.'\n- If they ask what FHIR is, explain: 'It‚Äôs a standard format for medical data. Some clinics may be able to import it directly.'\n- Reassure: 'This isn‚Äôt a diagnosis, but a summary of what‚Äôs been recorded and assessed so far.'",
          "summary_keywords": ["export", "summary", "PDF", "FHIR"]
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["user_id"],
                "properties": {
                  "user_id": {
                    "type": "string",
                    "description": "ID used in triage/symptom logs",
                    "example": "user_abc123"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Returns PDF URL and FHIR bundle",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "pdf_url": {
                      "type": "string",
                      "description": "Signed Azure Blob URL to download summary PDF",
                      "example": "https://concussionexports.blob.core.windows.net/exports/summary_abc123.pdf?...SAS_TOKEN..."
                    },
                    "fhir_bundle": {
                      "type": "object",
                      "description": "FHIR-compliant JSON bundle of symptom, triage, and stage data"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/get_symptom_log_map": {
      "get": {
        "summary": "Fetch Symptom Log Structure",
        "operationId": "getSymptomLogMap",
        "tags": ["Symptoms"],
        "x-gpt-action": {
          "name": "Get Symptom Log Map",
          "instructions": "Call this to structure a follow-up symptom check-in.\n- Use the `prompt` to introduce the check-in\n- Walk through each `symptoms` entry and ask for a 1‚Äì10 score\n- If any `linked_symptoms` are mentioned, ask follow-up questions\n- Honor the `guidance` field: if severity ‚â• threshold, inform the user and consider flagging it\n\nExample message: 'Let‚Äôs review your symptoms today. How would you rate your headache from 1 to 10?'",
          "summary_keywords": ["symptom", "check-in", "severity", "red flag"]
        },
        "responses": {
          "200": {
            "description": "Structured symptom check-in logic",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "symptom_log": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "string", "example": "symptom_checkin_block" },
                          "prompt": { "type": "string", "example": "Let's review your symptoms. Please rate the severity of each one." },
                          "linked_symptoms": {
                            "type": "array",
                            "items": { "type": "string" },
                            "example": ["headache", "dizziness"]
                          },
                          "symptoms": {
                            "type": "array",
                            "items": { "type": "string" },
                            "example": ["physical_headache", "sleep_difficulty"]
                          },
                          "guidance": {
                            "type": "object",
                            "properties": {
                              "red_flag_if": {
                                "type": "array",
                                "items": { "type": "string" },
                                "example": ["red_flag_nausea"]
                              },
                              "escalate_if": {
                                "type": "array",
                                "items": {
                                  "type": "object",
                                  "properties": {
                                    "condition": { "type": "string", "example": "severity >= 4" },
                                    "message": { "type": "string", "example": "This symptom may need further evaluation." }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "required_fields": {
                          "type": "array",
                          "items": { "type": "string" },
                          "example": ["reporter_type", "sport_type"]
                        },
                        "notes": { "type": "string" }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/get_linked_symptoms/{user_id}": {
      "get": {
        "summary": "Get Logged Symptoms",
        "operationId": "getLinkedSymptoms",
        "tags": ["Symptoms"],
        "parameters": [
          {
            "name": "user_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "example": "user_abc123"
            },
            "description": "The user ID to fetch symptom logs for"
          }
        ],
        "x-gpt-action": {
          "name": "View Logged Symptoms",
          "instructions": "Use this to show a user their past symptom check-ins.\n\nReturns a list of all symptoms recorded for the given user_id, including:\n- `symptom_id`: canonical symptom name\n- `score`: 1‚Äì10 severity score\n- `notes`: optional metadata or freeform notes\n- `timestamp`: when the symptom was logged\n\nüß† How to communicate results:\n- 'Here are the symptom check-ins you‚Äôve recorded.'\n- Explain trends: 'Looks like headache severity dropped from 6 to 2 over the last week.'\n- Offer next steps: 'Want to do another check-in now?'\n- Reassure: 'This is just for tracking ‚Äî it‚Äôs not a clinical diagnosis.'",
          "summary_keywords": ["symptoms", "history", "log"]
        },
        "responses": {
          "200": {
            "description": "List of logged symptoms with scores and timestamps",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "symptom_id": { "type": "string", "example": "headache" },
                      "score": { "type": "integer", "example": 5 },
                      "notes": { "type": "string", "example": "User noted mild throbbing after school." },
                      "timestamp": { "type": "string", "format": "date-time", "example": "2025-05-10T14:00:00Z" }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/log_activity_checkin": {
      "post": {
        "operationId": "logActivityCheckin",
        "summary": "Log activity check-in",
        "tags": ["Activity"],
        "x-gpt-action": {
          "name": "Log Activity Check-in",
          "instructions": "Use this after the user reports trying out a stage‚Äôs activities. Ask which activities they attempted and whether their symptoms worsened afterwards. You must record both the symptoms they experienced and whether symptoms worsened.\n\nRequired fields:\n- `user_id`: unique ID for this user\n- `stage_attempted`: the stage they were trying (e.g., 'stage_2')\n- `timestamp`: when they did the activity\n- `symptoms`: dictionary of symptom descriptions and scores\n- `symptoms_worsened`: whether symptoms worsened after the activity\n\nAlways include optional notes if the user shares extra context (e.g., 'worse after biking').",
          "summary_keywords": ["activity", "log", "stage", "worsened", "check-in"]
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["user_id", "stage_attempted", "timestamp", "symptoms", "symptoms_worsened"],
                "properties": {
                  "user_id": {
                    "type": "string",
                    "description": "Unique user ID",
                    "example": "user_abc123"
                  },
                  "stage_attempted": {
                    "type": "string",
                    "description": "ID of the stage the user attempted (e.g., stage_2)",
                    "example": "stage_2"
                  },
                  "timestamp": {
                    "type": "string",
                    "format": "date-time",
                    "description": "When the user attempted the activities",
                    "example": "2025-05-13T10:00:00Z"
                  },
                  "symptoms": {
                    "type": "object",
                    "description": "Dictionary of { symptom: score } representing what they felt after the activity",
                    "example": {
                      "headache": 3,
                      "dizziness": 2
                    }
                  },
                  "symptoms_worsened": {
                    "type": "boolean",
                    "description": "Did their symptoms get worse after the activity?",
                    "example": false
                  },
                  "notes": {
                    "type": "string",
                    "description": "Optional user-provided context or observations",
                    "example": "Felt more tired after stretching"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Activity and symptoms logged successfully"
          }
        }
      }
    },
    "/get_stage_overview": {
      "get": {
        "operationId": "getStageOverview",
        "summary": "List all recovery stages",
        "tags": ["Stage"],
        "x-gpt-action": {
          "name": "Get Stage Overview",
          "instructions": "Use this to show the user all recovery stages and help them understand the return-to-play process. Include the stage name, summary, allowed activities, and progression criteria. This is useful after a concussion assessment or if the user asks 'what‚Äôs next' or 'what are the steps?'.\n\nYou can also reference this to help the user decide which stage they attempted during check-ins.",
          "summary_keywords": ["stage", "recovery", "overview", "activities"]
        },
        "responses": {
          "200": {
            "description": "List of all defined recovery stages",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "stage_id": { "type": "string", "example": "stage_2" },
                      "stage_number": { "type": "integer", "example": 2 },
                      "name": { "type": "string", "example": "Light Aerobic Exercise" },
                      "summary": {
                        "type": "string",
                        "example": "You may begin light movement like walking or stationary biking."
                      },
                      "activities": {
                        "type": "array",
                        "items": { "type": "string" },
                        "example": ["Walking", "Stationary cycling"]
                      },
                      "progression_criteria": {
                        "type": "array",
                        "items": { "type": "string" },
                        "example": [
                          "At least 24 hours symptom-free at this level.",
                          "No symptom worsening with light exertion."
                        ]
                      },
                      "guidance_phrases": {
                        "type": "array",
                        "items": { "type": "string" },
                        "example": [
                          "You‚Äôre in Stage 2. Light activity is a great first step as long as symptoms don‚Äôt worsen.",
                          "Keep it light and stop if anything feels off."
                        ]
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/get_checkin_flow": {
      "get": {
        "operationId": "getCheckinFlow",
        "summary": "Load check-in question map",
        "tags": ["Checkin"],
        "x-gpt-action": {
          "name": "Get Check-in Flow",
          "instructions": "Use this to start a structured check-in after a user attempts stage activities. Walk through questions one at a time using `prompt`, track the `id`, and apply the `mode` (e.g., probe, clarify).\n\nKey behavior:\n- Track each answer in an `answers` map like `{ id: answer }`\n- After final question, call `/log_activity_checkin` with full payload\n- If the `options` field is present and includes stage IDs, do not show them directly. Instead, call `/get_stage_overview` to get user-friendly names and summaries, and use those to help the user identify the correct stage (e.g., 'Light aerobic exercise').\n- If the `note` field is present, follow its instructions to support GPT behavior (e.g., clarify mappings or special logic)\n\nüîç If the intent is `collect_symptoms`:\n- Use `symptom_links` to match to known symptoms\n- Ask for severity (1‚Äì10)\n- Format as: `{ symptom_id: score }`",
          "summary_keywords": ["check-in", "questions", "activity", "symptoms"]
        },
        "responses": {
          "200": {
            "description": "List of structured check-in questions",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "questions": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": { "type": "string", "example": "stage_attempted" },
                          "prompt": {
                            "type": "string",
                            "example": "Did you try any of these activities recently?"
                          },
                          "type": { "type": "string", "example": "select" },
                          "intent": { "type": "string", "example": "identify_stage" },
                          "mode": {
                            "type": "string",
                            "example": "clarify",
                            "description": "Use 'probe' to follow up, 'clarify' to confirm unclear responses"
                          },
                          "response_parsing": {
                            "type": "string",
                            "example": "stage_id"
                          },
                          "note": {
                            "type": "string",
                            "example": "GPT should call get_stage_overview and map user responses to stage_id"
                          },
                          "options": {
                            "type": "array",
                            "items": { "type": "string" },
                            "description": "If this is a pick-list question, these are the allowed values",
                            "example": ["stage_1", "stage_2", "stage_3"]
                          },
                          "example_user_answers": {
                            "type": "array",
                            "items": { "type": "string" },
                            "example": ["Yes, I did light biking and walking"]
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/get_user_history": {
      "post": {
        "operationId": "getUserHistory",
        "summary": "Fetch prior user data for continuity",
        "tags": ["User"],
        "x-gpt-action": {
          "name": "Get User History",
          "instructions": "Use this when GPT has no memory of prior conversation and needs to 'pick up where it left off'.\n\nThis tool returns any known data previously logged by the user ‚Äî such as injury date, symptom check-ins, or past activities. Use this to:\n\n- Avoid re-asking questions (e.g., 'when was your injury?')\n- Pre-fill answers for the check-in flow (e.g., latest symptoms, last stage attempted)\n- Re-engage returning users by offering contextual guidance (e.g., 'Last time you tried Stage 2 ‚Äî want to continue?')\n\nOnly use this if no other memory is available ‚Äî skip it in continuous flows.",
          "summary_keywords": ["user", "history", "symptoms", "incident", "stage"]
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["user_id"],
                "properties": {
                  "user_id": {
                    "type": "string",
                    "description": "The user ID to look up",
                    "example": "user_001"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Returns known information previously logged by the user",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "incident_logged": { "type": "boolean", "example": true },
                    "incident_info": {
                      "type": "object",
                      "properties": {
                        "injury_date": { "type": "string", "example": "2025-05-01" },
                        "reporter_role": { "type": "string", "example": "my son" },
                        "sport_type": { "type": "string", "example": "soccer" },
                        "diagnosed_concussion": { "type": "boolean", "example": false }
                      }
                    },
                    "last_symptom_log_timestamp": {
                      "type": "string",
                      "example": "2025-05-12T10:00:00Z"
                    },
                    "last_symptom_log": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "symptom_id": { "type": "string", "example": "headache" },
                          "score": { "type": "integer", "example": 3 }
                        }
                      }
                    },
                    "last_activity_checkin": {
                      "type": "object",
                      "properties": {
                        "stage_attempted": { "type": "string", "example": "stage_2" },
                        "timestamp": { "type": "string", "example": "2025-05-12T10:00:00Z" },
                        "symptoms_worsened": { "type": "boolean", "example": false }
                      }
                    },
                    "stages_attempted": {
                      "type": "array",
                      "items": { "type": "string" },
                      "example": ["stage_1", "stage_2"]
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}