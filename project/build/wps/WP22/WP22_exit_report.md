# WP22 Exit Report – GoC Alignment Search Tool

## 🎯 Objectives
- Enable alignment of draft policy content to Government of Canada (GoC) priorities.
- Support high-quality artifact generation by enriching inputs to drafting tools.
- Allow alignment scanning from mandate letters, strategies, and public plans.

## 🔨 Deliverables and Tooling
### ✅ Tools Built or Updated
- **`goc_alignment_search.py`**: Searches live GoC web content.
- **`queryCorpus.py`**: Queries embedded government document corpus.
- **`queryPromptGenerator`**: Synthesizes a structured query from memory and project profile.
- **`section_synthesizer.py`** (patched): Integrates all structured sources into draft.
- **`generate_section_chain.py`** (patched): Full pipeline orchestration.
- **Async support**: Converted `loadCorpus.py` to async to support background embedding.

### 🔗 Integration Targets
- `planner_orchestrator.py`
- `generate_section_chain.py`

## 🔁 E2E Flow Summary
### 🔹 In Toolchain (Auto Mode)
1. **User** triggers a new section draft.
2. **`generate_section_chain`** orchestrates tools:
   - Fetches memory.
   - Generates structured query.
   - Runs `queryCorpus`, `goc_alignment_search`, `webSearch`.
   - Summarizes and bundles structured inputs.
   - Calls `section_synthesizer` → `section_refiner` → saves output.

### 🔹 Standalone Use
- `queryCorpus` and `goc_alignment_search` can be used interactively via prompt to:
  - Find matching policies
  - Copy into a section
  - Justify alignment with mandates

## 📈 Data Flow & Schema
- `loadCorpus` embeds PDF/doc into Chroma DB with metadata
- `queryCorpus` returns:
  ```json
  {
    "answer": "...synthesized response from nearest chunk(s)..."
  }
  ```
- `goc_alignment_search` returns list of search result dicts:
  ```json
  [{"title": "...", "snippet": "...", "url": "..."}]
  ```
- `queryPromptGenerator` returns structured query string
- All inputs collected into `section_synthesizer` as labeled sources

## ⚙️ Technical Design
- Follows `Tool` class structure
- Registered in `tool_catalog.yaml` and `gpt_tools_manifest.json`
- `web_search_logger.py` logs web activity for traceability
- `generate_section_chain` uses OpenAI to summarize external sources before prompting

## 🗂️ File Paths
- `app/tools/tool_wrappers/goc_alignment_search.py` – new tool wrapper
- `app/tools/tool_wrappers/queryCorpus.py` – new tool wrapper
- `app/tools/tool_wrappers/loadCorpus.py` – patched for async
- `app/tools/tool_wrappers/section_synthesizer.py` – patched to structure inputs
- `app/engines/toolchains/generate_section_chain.py` – patched orchestration
- `project/build/wps/WP22/load_opengov2023_corpus.py` – test corpus loader
- `project/test/wps/WP22/test_queryCorpus_remote_http.py` – integration test script
- `project/reference/tool_catalog.yaml`, `gpt_tools_manifest.json` – tool registration

## 🚀 Future Enhancements
- Use metadata filters to narrow corpus queries
- Train embedding on bilingual corpus (EN/FR)
- Enable export of alignment logs as structured justification
- Add scoring/ranking for alignment confidence

## 🤖 Notes for GPTs and Pods
- Use `queryCorpus` and `goc_alignment_search` when drafting new content with GoC context
- Default queries are autogenerated, but can be overridden by users
- Results are logged to PromptLog and ReasoningTrace for traceability
