
### 🧠 WP9 Design Plan — Input Ingestion System

#### 🎯 Goal
Enable PolicyGPT to ingest, sanitize, structure, and persist diverse user inputs — including files, links, and direct text — into mid-term memory and YAML traces compatible with planner toolchains.

---

### 🗺️ Scope and Inputs
- From: `WP9_definition.md`, `PolicyGPT_Features v2.md`, `session_memory_model_v2.md`
- Inputs: file uploads (.pdf, .docx, .txt), URLs, raw text
- Outputs: YAML trace logs, structured summaries in memory

---

### 🧩 System Design

#### ⚙️ Components
1. **Tool Wrappers**
   - `uploadTextInput`
   - `uploadFileInput`
   - `uploadLinkInput`
   - Each implements `Tool.run_tool(input_dict)`

2. **Text Extraction Engine**
   - Built in `text_extractor.py`
   - Uses `textract`, `beautifulsoup4`, `python-docx`, etc.
   - Normalizes encoding, extracts plain text

3. **Structured Ingestor**
   - Maps extracted content into YAML summaries
   - Adds source metadata: origin, timestamp, author, type

4. **Memory Writer**
   - Uses `memory_sync.py`
   - Writes prompt logs and session snapshots
   - Ensures each input is replayable

5. **Retry Handler**
   - Implements `retry_ingestion.py`
   - Captures parse/validation errors and retries

---

### ✅ Acceptance Criteria (Mapped)
| Requirement | Approach |
|------------|----------|
| Input types handled | Each tool wrapper targets one input class |
| Structured outputs | YAML + mid-term memory writes, validated via schema |
| CLI testability | CLI entry point will allow local dev and test |
| Error retry | Retry handler wraps all tool calls |
| Toolchain-ready | Schema added to `tool_catalog.yaml` and wrappers structured |

---

### 🧪 Testing Plan
- Inputs: `.pdf`, `.docx`, `.txt`, raw text, URL
- Output: compare YAML trace and memory snapshot against schema
- Log: trace YAML in `/logs/ingest_traces/`, JSON in `/logs/session_snapshots/`

---

### 🧠 Trace Logging Format
```yaml
- source: "my_file.pdf"
  type: "uploadFileInput"
  timestamp: "2025-05-19T13:00Z"
  content_summary: |
    "This document outlines..."
  tags: ["input", "upload"]
```

---

### 🧱 Integration Hooks
- Tool Registry: YAML + OpenAPI ready
- Planner: YAML output can be used as prompt or context
- Mid-Term Memory: Writes to `PromptLog` + `SessionSnapshot`

---

### 🔒 Risk Mitigations
- Parser fails → routed through retry with fallback
- Encoding/format noise → `text_extractor.py` handles normalization
- YAML structure drift → schemas validated via tool registry

---

### 🔗 Interfaces Used
- `tool_registry.py`
- `tool_catalog.yaml`
- `memory_sync.py`
- `planner_orchestrator.py` (indirect)

---

### 🔄 Integration with WP16 + PolicyGPT User Flow

#### 🧭 Dual Input Modes (from WP16)
- **Guided Prompt Mode**: Users respond to dynamic prompts generated by `input_prompt_generator.py`. Inputs flow into WP9’s `uploadTextInput` tool for ingestion.
- **Data Dump Mode**: Users upload multiple files/links or paste unstructured text. Each is processed through WP9’s ingestion tools (`uploadFileInput`, `uploadLinkInput`).

#### 🔄 Shared Processing Layer
- Regardless of entry path, all inputs flow through:
  - Sanitization/parsing (`text_extractor.py`)
  - Structure/tagging (`structured_input_ingestor.py`)
  - Memory logging (`memory_sync.py`)

---

### 📁 Multi-Input Support
- **YES**: WP9 supports ingesting multiple files/text blocks at once.
- Processed in batch under-the-hood, each routed through tool wrappers.
- Minimizes user friction in “data dump” scenarios.

---

### 🧠 Memory and Storage Targets
| Layer | Role |
|-------|------|
| `PromptLog` | Stores sanitized content and metadata from each input |
| `SessionSnapshot` | Captures aggregate view post-ingestion |
| `ingest_trace.yaml` | Trace log per input — debuggable and replayable |
| `project_profile.yaml` | Optionally stores source mappings |
| External Storage | Not in WP9 scope — future file persistence to Drive/blob |

---

### 🧾 Role in Content Generation
- Ingested inputs are mid-term memory for planner prompts.
- Used in filling structured templates, grounding GPT responses.
- Toolchain can cite origin content or trace to sections.
- Enables WP16’s completeness checker and WP1a’s section composer.

---

### 🎯 Summary
WP9 is a foundation for memory-grounded, traceable inputs. It supports both user-facing flows and backend orchestration across planner and generation WPs.

---

### 📦 Input Storage Coverage — Current vs. Planned

#### ✅ Done:
- YAML trace logs (`logs/ingest_traces/*.yaml`) created for each input
- Tools output replayable metadata-rich input summaries
- CLI-compatible and schema-aligned ingestion

#### 🔜 Not Yet Implemented:
- `PromptLog` DB writes via `memory_sync.py`
- `SessionSnapshot` population for aggregate memory
- Retry handler (`retry_ingestion.py`) stubbed but not wired

---

### 📋 Updated Remaining Tasks:
1. **DB Writes**: Integrate `memory_sync.py` to log each input into `PromptLog`
2. **Session Snapshot**: Capture a session-level snapshot after batch ingestion
3. **Test Harness**: Validate both logs and DB records
4. **Retry Path**: Wire in retry logging for failed or malformed inputs
5. **Deploy Hooks**: If DB or memory setup needs init in Railway
6. **Completion Note**: Include DB + trace coverage summary

---

### 🧠 Snapshot System Role in Memory and Planner Flow

#### 🧾 Purpose of Snapshot
- Snapshot files act as **versioned check-points** for what the user has uploaded or entered up to a given point in time.
- These are used by the Planner (`planner_orchestrator.py`) to ground prompt generation, tool routing, and document assembly.

#### 🧱 PromptLog vs. SessionSnapshot
| Table | Purpose | Granularity | Used By |
|-------|---------|-------------|---------|
| `PromptLog` | Stores each ingestion event (file, link, text) | Fine-grained | Audit trail, trace replay, debugging |
| `SessionSnapshot` | Stores bundled summary of all relevant `PromptLog` entries | Coarse-grained | Planning, versioning, rehydration |

#### 🛠️ Snapshot Tool Behavior
- Queries `PromptLog` for entries tied to a `session_id` (if provided) or full table
- Saves selected entries into `logs/session_snapshots/snapshot_<session_id>_<timestamp>.yaml`
- Logs metadata into `SessionSnapshot` DB table for planner/system use

#### 🔄 Integration Point
Once a snapshot is created:
- Planner loads it via `load_latest_snapshot()` (recently re-added)
- All retrieved entries can then be passed into toolchains for draft generation, rewriting, or gate document assembly
